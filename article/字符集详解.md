https://javaguide.cn/database/character-set.html

# 字符集详解
[Guide]()   数据库  数据库基础  约 3290 字  大约 11 分钟

此页内容
- [字符集是什么？]()
- [字符编码是什么？]()
- [有哪些常见的字符集？]()
  - [ASCII]()
  - [GB2312]()
  - [GBK]()
  - [GB18030]()
  - [BIG5]()
  - [Unicode & UTF-8]()
- [MySQL 字符集]()
  - [查看支持的字符集]()
  - [默认字符集]()
  - [字符集的层次级别]()
    - [server]()
    - [database]()
    - [table]()
    - [column]()
  - [连接字符集]()
  - [JDBC 对连接字符集的影响]()
  - [UTF-8 使用]()
- [参考]()

MySQL 字符编码集中有两套 UTF-8 编码实现：**`utf8`** 和**`utf8mb4`** 。

如果使用**`utf8`** 的话，存储 emoji 符号和一些比较复杂的汉字、繁体字就会出错。


## 字符集是什么？
字符是各种文字和符号的统称，包括各个国家文字、标点符号、表情、数字等等。**字符集就是一系列字符的集合**。字符集的种类较多，每个字符集可以表示的字符范围通常不同，就比如说有些字符集是无法表示汉字的。

**计算机只能存储二进制的数据，那英文、汉字、表情等字符应该如何存储呢？**

我们要将这些字符和二进制的数据一一对应起来，比如说字符“a”对应“01100001”，反之，“01100001”对应 “a”。我们将字符对应二进制数据的过程称为"**字符编码**"，反之，二进制数据解析成字符的过程称为“**字符解码**”。


## 字符编码是什么？
**字符编码是一种将字符集中的字符与计算机中的二进制数据相互转换的方法，可以看作是一种映射规则**。也就是说，字符编码的目的是为了让计算机能够存储和传输各种文字信息。

每种字符集都有自己的字符编码规则，常用的字符集编码规则有 ASCII 编码、 GB2312 编码、GBK 编码、GB18030 编码、Big5 编码、UTF-8 编码、UTF-16 编码等。


## 有哪些常见的字符集？
常见的字符集有：ASCII、GB2312、GB18030、GBK、Unicode……。

不同的字符集的主要区别在于：
- 可以表示的字符范围
- 编码方式

### ASCII
**ASCII（American Standard Code for Information Interchange，美国信息交换标准代码）是一套主要用于现代美国英语的字符集**（这也是 ASCII 字符集的局限性所在）。

**为什么 ASCII 字符集没有考虑到中文等其他字符呢？** 因为计算机是美国人发明的，当时，计算机的发展还处于比较雏形的时代，还未在其他国家大规模使用。因此，美国发布 ASCII 字符集的时候没有考虑兼容其他国家的语言。

ASCII 字符集至今为止共定义了 128 个字符，其中有 33 个控制字符（比如回车、删除）无法显示。

一个 ASCII 码长度是一个字节也就是 8 个 bit，比如“a”对应的 ASCII 码是“01100001”。不过，最高位是 0 仅仅作为校验位，其余 7 位使用 0 和 1 进行组合，所以，**ASCII 字符集可以定义 128（2^7）个字符**。

由于 ASCII 码可以表示的字符实在太少，人们对其进行扩展得到了**ASCII 扩展字符集**。ASCII 扩展字符集使用 8 位（bits）表示一个字符，所以，**ASCII 扩展字符集可以定义 256（2^8）个字符**。

![ASCII字符编码]()

### GB2312
GB2312 字符集是一种对汉字比较友好的字符集，**共收录 6700 多个汉字，基本涵盖了绝大部分常用汉字**。不过，**GB2312 字符集不支持绝大部分的生僻字和繁体字**。

对于英语字符，GB2312 编码和 ASCII 码是相同的，1 字节编码即可。对于非英字符，需要 2 字节编码。

### GBK
**GBK 字符集可以看作是 GB2312 字符集的扩展，兼容 GB2312 字符集**，共收录了 20000 多个汉字。

GBK 中 K 是汉语拼音 Kuo Zhan（扩展）中的“Kuo”的首字母。

### GB18030
**GB18030 完全兼容 GB2312 和 GBK 字符集**，纳入中国国内少数民族的文字，且收录了日韩汉字，是目前为止最全面的汉字字符集，共收录汉字 70000 多个。

### BIG5
**BIG5 主要针对的是繁体中文，收录了 13000 多个汉字**。

### Unicode & UTF-8
为了更加适合本国语言，诞生了很多种字符集。不同的字符集在字符范围和编码规则上的差异，导致了一个严重问题：**使用错误的编码方式查看包含字符的文件会产生乱码现象**。

示例：“牛”这个汉字 GB2312 编码后的十六进制数值为 “C5A3”，而 “C5A3” 用 UTF-8 解码之后得到的却是 “ţ”。（可通过[在线编码转换工具](https://www.haomeili.net/HanZi/ZiFuBianMaZhuanHuan)验证）

由此可明确乱码的本质：**编码和解码时用了不同或者不兼容的字符集**。

为解决这一问题，**Unicode 字符集**诞生，其使命是纳入世界上几乎所有已知的字符。但注意：**Unicode 字符集仅定义字符集合，并未规定如何存储这些字符（即如何用二进制表示）**。

基于 Unicode 字符集，衍生出了对应的编码方案，包括：
- **UTF-8（8-bit Unicode Transformation Format）**：使用 1 到 4 个字节为每个字符编码，是目前使用最广的字符编码。
- UTF-16：使用 2 或 4 个字节为每个字符编码。
- UTF-32：固定用 4 个字节为每个字符编码，缺陷是对英文字母等字符的空间消耗是 UTF-8 的 4 倍。

UTF-8 的核心优势：**可根据符号自动选择编码长度**，英文字符仅需 1 个字节（与 ASCII 码兼容），中文通常需 3 个字节，emoji 等特殊字符需 4 个字节。


## MySQL 字符集
MySQL 支持多种字符集，比如 GB2312、GBK、BIG5、多种 Unicode 字符集（UTF-8 编码、UTF-16 编码、UCS-2 编码、UTF-32 编码等）。

### 查看支持的字符集
可通过 **`SHOW CHARSET` 命令**查看，支持 like 和 where 子句过滤结果。

### 默认字符集
- **MySQL5.7 中，默认字符集是 `latin1`**；
- **MySQL8.0 中，默认字符集是 `utf8mb4`**。

### 字符集的层次级别
MySQL 字符集分为 4 个层次级别，优先级从低到高为：**server（实例级） < database（库级） < table（表级） < column（字段级）**。即低级别未指定时，继承高级别的字符集；若低级别指定了字符集，则覆盖高级别设置。

#### server（实例级）
- 默认值：MySQL5.7 为 `latin1`，MySQL8.0 为 `utf8mb4`。
- 配置方式：
  1. 启动 `mysqld` 时指定参数：
     ```shiki shiki-themes one-light one-dark-pro vp-code
     mysqld --character-set-server=utf8mb4
     # 可同时指定排序规则
     mysqld --character-set-server=utf8mb4 \
       --collation-server=utf8mb4_0900_ai_ci
     ```
  2. 源码构建时通过 `cmake` 指定：
     ```shiki shiki-themes one-light one-dark-pro vp-code
     cmake . -DDEFAULT_CHARSET=latin1
     # 可同时指定排序规则
     cmake . -DDEFAULT_CHARSET=latin1 \
       -DDEFAULT_COLLATION=latin1_german1_ci
     ```
  3. 运行时修改：直接调整 `character_set_server` 变量值。
- 作用：作为创建/修改数据库的默认字符集（未指定其他字符集时），同时影响客户端与服务器的连接字符集。

#### database（库级）
- 配置方式：创建或修改数据库时指定：
  ```shiki shiki-themes one-light one-dark-pro vp-code
  # 创建数据库
  CREATE DATABASE db_name
      [[DEFAULT] CHARACTER SET charset_name]
      [[DEFAULT] COLLATE collation_name]
  # 修改数据库
  ALTER DATABASE db_name
      [[DEFAULT] CHARACTER SET charset_name]
      [[DEFAULT] COLLATE collation_name]
  ```
- 继承规则：未指定时，继承 `server` 级字符集。
- 查看方式：
  ```shiki shiki-themes one-light one-dark-pro vp-code
  USE db_name;
  SELECT @@character_set_database, @@collation_database;
  # 或通过 INFORMATION_SCHEMA 查看
  SELECT DEFAULT_CHARACTER_SET_NAME, DEFAULT_COLLATION_NAME
  FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME = 'db_name';
  ```

#### table（表级）
- 配置方式：创建或修改表时指定：
  ```shiki shiki-themes one-light one-dark-pro vp-code
  # 创建表
  CREATE TABLE tbl_name (column_list)
      [[DEFAULT] CHARACTER SET charset_name]
      [COLLATE collation_name]]
  # 修改表
  ALTER TABLE tbl_name
      [[DEFAULT] CHARACTER SET charset_name]
      [COLLATE collation_name]
  ```
- 继承规则：未指定时，继承 `database` 级字符集。

#### column（字段级）
- 配置方式：创建或修改表时，在字段定义中指定：
  ```shiki shiki-themes one-light one-dark-pro vp-code
  CREATE TABLE t1
  (
      col1 VARCHAR(5)
        CHARACTER SET latin1
        COLLATE latin1_german1_ci
  );
  ```
- 继承规则：未指定时，继承 `table` 级字符集。

### 连接字符集
连接字符集与客户端和服务器的通信相关，核心关联 3 个变量：
- **`character_set_client`**：客户端发送给服务器的 SQL 语句使用的字符集。
- **`character_set_connection`**：服务器接收 SQL 语句后，用于翻译的字符集。
- **`character_set_results`**：服务器返回给客户端的结果使用的字符集。

#### 查看变量值
```shiki shiki-themes one-light one-dark-pro vp-code
# 方式1：通过 performance_schema 查看
SELECT * FROM performance_schema.session_variables
WHERE VARIABLE_NAME IN (
'character_set_client', 'character_set_connection',
'character_set_results', 'collation_connection'
) ORDER BY VARIABLE_NAME;

# 方式2：通过 SHOW 命令查看
SHOW SESSION VARIABLES LIKE 'character\_set\_%';
```

#### 修改变量值
1. 修改配置文件（仅针对 MySQL 客户端程序）：
   ```shiki shiki-themes one-light one-dark-pro vp-code
   [mysql]
   default-character-set=utf8mb4
   ```
2. 执行 SQL 语句（会话级别生效）：
   ```shiki shiki-themes one-light one-dark-pro vp-code
   # 一次性修改三个变量
   set names utf8mb4
   # 或逐个修改
   # SET character_set_client = utf8mb4;
   # SET character_set_results = utf8mb4;
   # SET collation_connection = utf8mb4;
   ```

### JDBC 对连接字符集的影响
实际场景中可能遇到“存储 emoji 正常，但用 Navicat 等工具查询时显示为问号”的问题，大概率是 JDBC 驱动影响了连接字符集。

`mysql-connector-java`（JDBC 驱动）主要通过两个属性控制连接字符集：
- **`characterEncoding`**
- **`characterSetResults`**

示例问题：在 `DataGrip 2023.1.2` 中，`characterSetResults` 默认值为 `utf8`，使用 `mysql-connector-java 8.0.25` 时，连接字符集会被设置为 `utf8mb3`（即 MySQL 中的 `utf8`），导致 emoji 显示为问号；而升级到 `mysql-connector-java 8.0.29` 后，支持将 `characterSetResults` 设置为 `utf8mb4`，问题可解决。

### UTF-8 使用
#### 两套 UTF-8 实现的区别
MySQL 中存在两套 UTF-8 编码实现，核心差异在于支持的字符字节长度：
- **`utf8`**：仅支持 1-3 个字节的字符，无法存储 emoji 符号、复杂汉字/繁体字（需 4 个字节）。
- **`utf8mb4`**：UTF-8 的完整实现，支持 1-4 个字节的字符，可正常存储 emoji、复杂汉字/繁体字。

#### 避坑建议
若需存储 emoji、复杂汉字/繁体字，**必须将数据库编码指定为 `utf8mb4`，而非 `utf8`**，否则会报错。

#### 错误示例（MySQL 5.7+）
1. 建表（指定 CHARSET 为 `utf8`）：
   ```shiki shiki-themes one-light one-dark-pro vp-code
   CREATE TABLE `user` (
     `id` varchar(66) CHARACTER SET utf8mb3 NOT NULL,
     `name` varchar(33) CHARACTER SET utf8mb3 NOT NULL,
     `phone` varchar(33) CHARACTER SET utf8mb3 DEFAULT NULL,
     `password` varchar(100) CHARACTER SET utf8mb3 DEFAULT NULL
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
   ```
2. 插入含 emoji 的数据（报错）：
   ```shiki shiki-themes one-light one-dark-pro vp-code
   INSERT INTO `user` (`id`, `name`, `phone`, `password`)
   VALUES
    ('A00003', 'guide哥😘😘😘', '181631312312', '123456');
   ```
3. 报错信息：
   ```shiki shiki-themes one-light one-dark-pro vp-code
   Incorrect string value: '\xF0\x9F\x98\x98\xF0\x9F...' for column 'name' at row 1
   ```


## 参考
- 字符集和字符编码（Charset & Encoding）：[https://www.cnblogs.com/skynet/archive/2011/05/03/2035105.html]()
- 十分钟搞清字符集和字符编码：[http://cenalulu.github.io/linux/character-encoding/]()
- Unicode-维基百科：[https://zh.wikipedia.org/wiki/Unicode]()
- GB2312-维基百科：[https://zh.wikipedia.org/wiki/GB_2312]()
- UTF-8-维基百科：[https://zh.wikipedia.org/wiki/UTF-8]()
- GB18030-维基百科:[https://zh.wikipedia.org/wiki/GB_18030]()
- MySQL8 文档：[https://dev.mysql.com/doc/refman/8.0/en/charset.html]()
- MySQL5.7 文档：[https://dev.mysql.com/doc/refman/5.7/en/charset.html]()
- MySQL Connector/J 文档：[https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-reference-charsets.html]()
