https://javaguide.cn/high-performance/cdn.html

# CDN工作原理详解
## 什么是 CDN ？
**CDN** 全称是 Content Delivery Network/Content Distribution Network，翻译后的意思是**内容分发网络** 。

我们可以将内容分发网络拆开来看：
- 内容：指的是静态资源，比如图片、视频、文档、JS、CSS、HTML。
- 分发网络：指的是将这些静态资源分发到位于多个不同地理位置机房中的服务器上，这样就可以实现静态资源的就近访问，比如北京的用户直接访问北京机房的数据。

所以，简单来说，**CDN 就是将静态资源分发到多个不同的地方以实现就近访问，进而加快静态资源的访问速度，减轻服务器以及带宽的负担。**

类似于京东建立的庞大仓储运输体系，京东物流在全国拥有非常多的仓库，仓储网络几乎覆盖全国所有区县。这样一来，用户下单后，商品能从距离用户最近的仓库直接发往配送站，再由配送员送达。

你可以将 CDN 看作是服务上一层的特殊缓存服务，分布在全国各地，主要用来处理静态资源的请求。

需要注意的是，不要混淆全站加速和内容分发网络！全站加速（不同云服务商叫法不同，腾讯云叫 ECDN、阿里云叫 DCDN）既可以加速静态资源，又可以加速动态资源；而内容分发网络（CDN）主要针对的是**静态资源** 。

绝大部分公司都会在项目开发中使用 CDN 服务，但很少有公司会自建 CDN 服务。基于成本、稳定性和易用性考虑，建议直接选择专业的云厂商（比如阿里云、腾讯云、华为云、青云）或者 CDN 厂商（比如网宿、蓝汛）提供的开箱即用的 CDN 服务。

很多人可能会问：**既然是就近访问，为什么不直接将服务部署在多个不同的地方呢？** 原因主要有两点：
1. 成本太高，需要部署多份相同的服务。
2. 静态资源通常占用空间较大且访问频繁，若直接用服务器或缓存处理静态资源请求，会大量消耗系统资源，可能影响系统其他服务的正常运行。

实际上，同一个服务在多个不同地方部署多份（比如同城灾备、异地灾备、同城多活、异地多活），目的是实现系统的高可用，而非就近访问。

## CDN 工作原理是什么？
搞懂以下 3 个问题，就能理解 CDN 的工作原理：
1. 静态资源是如何被缓存到 CDN 节点中的？
2. 如何找到最合适的 CDN 节点？
3. 如何防止静态资源被盗用？

### 静态资源是如何被缓存到 CDN 节点中的？
你可以通过**预热** 的方式将源站的资源同步到 CDN 的节点中。这样，用户首次请求资源时，就能直接从 CDN 节点获取，无需回源，从而降低源站压力，提升用户体验。

如果不进行预热，当用户访问的资源不在 CDN 节点中时，CDN 节点会请求源站获取资源，这个过程就是大家常说的**回源** 。

> - 回源：当 CDN 节点上没有用户请求的资源，或该资源的缓存已过期时，CDN 节点需要从原始服务器获取最新的资源内容，这个过程就是回源。若用户请求发生回源，该请求的响应速度可能比未使用 CDN 时更慢，因为相比未使用 CDN，多了一层 CDN 的调用流程。
> - 预热：预热是指在 CDN 上提前将内容缓存到 CDN 节点上。这样当用户请求这些资源时，能快速从最近的 CDN 节点获取，无需回源，进而减少对源站的访问压力，提高访问速度。

若资源有更新，你也可以对其进行**刷新** ——删除 CDN 节点上缓存的旧资源，并强制 CDN 节点回源站获取最新资源。

几乎所有云厂商提供的 CDN 服务都具备缓存的刷新和预热功能。

在衡量 CDN 服务质量时，**命中率** 和**回源率** 是两个重要指标：命中率越高越好，回源率越低越好。

### 如何找到最合适的 CDN 节点？
GSLB（Global Server Load Balance，全局负载均衡）是 CDN 的“大脑”，负责多个 CDN 节点之间的协作，其中最常用的是基于 DNS 的 GSLB。

CDN 通过 GSLB 找到最合适的 CDN 节点，具体流程如下：
1. 浏览器向 DNS 服务器发送域名请求；
2. DNS 服务器根据 CNAME（Canonical Name，别名记录）向 GSLB 发送请求；
3. GSLB 返回性能最好（通常是距离请求地址最近）的 CDN 节点（边缘服务器，即真正缓存内容的地方）的地址给浏览器；
4. 浏览器直接访问指定的 CDN 节点。

需要说明的是，上述流程经过了简化。GSLB 内部可看作是 CDN 专用 DNS 服务器和负载均衡系统的组合：CDN 专用 DNS 服务器会将负载均衡系统的 IP 地址返回给浏览器，浏览器再通过该 IP 地址请求负载均衡系统，进而找到对应的 CDN 节点。

那么，**GSLB 是如何选择出最合适的 CDN 节点呢？** 它会根据请求的 IP 地址、CDN 节点状态（比如负载情况、性能、响应时间、带宽）等指标综合判断，最终确定返回哪个 CDN 节点的地址。

### 如何防止资源被盗刷？
若静态资源被其他用户或网站非法盗刷，会产生不小的开支。解决这一问题最常用、最简单的办法是设置**Referer 防盗链** ，具体是根据 HTTP 请求头信息中的 Referer 字段对请求进行限制。通过 Referer 字段，我们能获取到当前请求页面的来源页面的网站地址，从而判断请求是否来自合法网站。

几乎所有 CDN 服务提供商都提供了这种基础的防盗链机制。不过，若站点的防盗链配置允许 Referer 为空，他人可通过隐藏 Referer 绕开防盗链。

因此，通常会配合其他机制确保静态资源安全，其中**时间戳防盗链** 是常用方式之一，且安全性更强。时间戳防盗链加密的 URL 具有时效性，过期后便无法访问。

时间戳防盗链的 URL 通常包含两个参数：签名字符串和过期时间。签名字符串一般是通过对用户设定的加密字符串、请求路径、过期时间，采用 MD5 哈希算法计算哈希值得到的。

时间戳防盗链 URL 示例：
```shiki shiki-themes one-light one-dark-pro vp-code
http://cdn.wangsu.com/4/123.mp3? wsSecret=79aead3bd7b5db4adeffb93a010298b5&wsTime=1601026312
```
- `wsSecret` ：签名字符串。
- `wsTime` : 过期时间。

时间戳防盗链的实现简单且可靠性较高，推荐使用，且绝大部分 CDN 服务提供商都提供了开箱即用的时间戳防盗链机制。

除了 Referer 防盗链和时间戳防盗链，还可以通过 IP 黑白名单配置、IP 访问限频配置等机制防止资源盗刷。

## 总结
1. CDN 是将静态资源分发到多个不同地方以实现就近访问，进而加快静态资源访问速度、减轻服务器及带宽负担的技术。
2. 基于成本、稳定性和易用性考虑，建议选择专业云厂商（如阿里云、腾讯云）或 CDN 厂商（如网宿、蓝汛）提供的 CDN 服务，而非自建。
3. GSLB（全局负载均衡）是 CDN 的核心，负责协调多个 CDN 节点，通过请求 IP 地址、节点状态等指标，为用户匹配最合适的 CDN 节点。
4. 为防止静态资源被盗用，可组合使用**Referer 防盗链** 和**时间戳防盗链** ，也可配合 IP 黑白名单、IP 访问限频等机制。

## 参考
- 时间戳防盗链 - 七牛云 CDN：[https://developer.qiniu.com/fusion/kb/1670/timestamp-hotlinking-prevention]()
- CDN 是个啥玩意？一文说个明白：[https://mp.weixin.qq.com/s/Pp0C8ALUXsmYCUkM5QnkQw]()
- 《透视 HTTP 协议》- 37 | CDN：加速我们的网络服务：[http://gk.link/a/11yOG]()
